---
lab:
    title: '13 - Azure Monitor'
    module: '模块 04 - 管理安全操作'
---

# 实验室 13：Azure Monitor
# 学生实验室手册

## 实验室场景

你需要创建监视虚拟机性能的概念证明。具体来说，你需要：

- 配置虚拟机，以便可以收集遥测和日志。
- 显示可以收集哪些遥测和日志。
- 显示如何使用和查询数据。 

> 对于本实验室中的所有资源，我们使用 **“美国东部”** 区域。请与讲师确认这是课堂上所使用的区域。 

## 实验室目标

在本实验室中，你将完成以下练习：

- 练习 1：使用 Azure Monitor 从 Azure 虚拟机收集数据

### 练习 1：使用 Azure Monitor 从 Azure 虚拟机收集数据

### 练习时间：20 分钟

在该练习中，你将完成以下任务： 

- 任务 1：部署 Azure 虚拟机 
- 任务 2：创建 Log Analytics 工作区
- 任务 3：启用 Log Analytics 虚拟机扩展
- 任务 4：收集虚拟机事件和性能数据
- 任务 5：查看和查询收集的数据 

#### 任务 1：部署 Azure 虚拟机

1. 登录 Azure 门户 **`https://portal.azure.com/`**。

    >**备注**： 使用此实验室使用的 Azure 订阅中具有所有者或参与者角色的帐户登录 Azure 门户。

1. 单击 Azure 门户右上角的第一个图标，打开 Cloud Shell。如果出现提示，请选择 **“PowerShell”** 和 **“创建储存”**。

1. 确保在“Cloud Shell”窗格左上角的下拉菜单中选中 **“PowerShell”**。

1. 在 Cloud Shell 窗格内的 PowerShell 会话中运行以下命令，创建一个将在本实验室中使用的资源组：
  
    ```powershell
    New-AzResourceGroup -Name AZ500LAB131415 -Location 'EastUS'
    ```

    >**备注**： 此资源组将用于实验室 13、14 和 15。 

1. 在 Cloud Shell 窗格内的 PowerShell 会话中运行下列命令，创建新的 Azure 虚拟机。 

    ```powershell
    New-AzVm -ResourceGroupName "AZ500LAB131415" -Name "myVM" -Location 'EastUS' -VirtualNetworkName "myVnet" -SubnetName "mySubnet" -SecurityGroupName   "myNetworkSecurityGroup" -PublicIpAddressName "myPublicIpAddress" -OpenPorts 80,3389
    ```

1.  当提示输入凭据时：

    |设置|值|
    |---|---|
    |用户 |**localadmin**|
    |密码|**Pa55w.rd1234**|

    >**备注**： 等待部署完成。 

1. 在“Cloud Shell”窗格中的 PowerShell 会话中，运行以下命令以确认创建了名为 **“myVM”** 的虚拟机，并且其 **“ProvisioningState”** 为 **“成功”**。

    ```powershell
    Get-AzVM -Name 'myVM' -ResourceGroupName 'AZ500LAB131415' | Format-Table
    ```

1. 关闭 Cloud Shell 窗格。 

#### 任务 2：创建 Log Analytics 工作区

此任务将创建一个 Log Analytics 工作区。 

1. 在 Azure 门户页面顶部的 **“搜索资源、服务和文档”** 文本框中，键入 **“Log Analytics 工作区”**，然后按 **“Enter”** 键。

1. 在“**Log Analytics 工作区**”边栏选项卡上，单击“**+ 创建**”。

1. 在 **“创建 Log Analytics 工作区”** 边栏选项卡的 **“基本”** 选项卡中，指定以下设置（将其他设置保留为默认值）：

    |设置|值|
    |---|---|
    |订阅|在本实验室中使用的 Azure 订阅的名称|
    |资源组|**AZ500LAB131415**|
    |名称|任何有效的全局唯一名称|
    |区域|**（美国）美国东部**|

1. 单击 **“下一步: 定价层 >”** ，在 **“创建 Log Analytics 工作区”** 边栏选项卡的 **“定价层”** 选项卡中，接受默认的 **“即用即付(每 GB 2018)”** 定价层，然后单击 **“查看 + 创建”**。

1. 在 **“创建 Log Analytics 工作区”** 边栏选项卡的 **“查看 + 创建”** 选项卡中，单击 **“创建”**。

#### 任务 3：启用 Log Analytics 虚拟机扩展

在此任务中，你将启用 Log Analytics 虚拟机扩展。此扩展在 Windows 和 Linux 虚拟机上安装 Log Analytics 代理。此代理从虚拟机收集数据，并将其传输到你指定的 Log Analytics 工作区。安装代理后，它将自动升级，以确保你始终拥有最新的功能和修补程序。 

1. 在 Azure 门户中，导航回 **“Log Analytics 工作区”** 边栏选项卡，然后在工作区列表中，单击表示你在上一个任务中创建的工作区的条目。

1. 在“**Log Analytics 工作区**”边栏选项卡的“**连接数据源**”部分，单击“**Azure 虚拟机(VM)**”条目。

    >**备注**： 为了成功安装代理，虚拟机必须正在运行。

1. 在虚拟机列表中，找到表示你在本练习的第一个任务中部署的 **Azure VM myVM** 的条目，并注意它被列为 **“未连接”**。

1. 单击 **“myVM”** 条目，然后在 **“myVM”** 边栏选项卡上单击 **“连接”**。 

1. 等待虚拟机连接到 Log Analytics 工作区。

    >**备注**： 这可能需要几分钟时间。 **“myVM”** 边栏选项卡上显示的 **“状态”** 将从 **“正在连接”** 变为 **“此工作区”**。 

#### 任务 4：收集虚拟机事件和性能数据

在此任务中要配置 Windows 系统日志和几个常见性能计数器的集合。还将查看其他可用资源。

1. 在 Azure 门户中，导航回到在本练习前面创建的 Log Analytics 工作区。

1. 在“Log Analytics 工作区”边栏选项卡上，单击 **“设置”** 部分中的 **“代理配置”**。

1. 在 **“代理配置”** 边栏选项卡上查看可配置的设置，包括 Windows 事件日志、Windows 性能计数器、Linux 性能计数器、IIS 日志和 Syslog。 

1. 确保选中“**Windows 事件日志**”，单击“**+ 添加 Windows 事件日志**”，然后在事件日志类型列表中选择“**系统**”。

    >**备注**： 这是将事件日志添加到工作区的方式。其他选择包括 **“硬件事件”** 或 **“密钥管理服务”** 等。  

1. 取消勾选 **“信息”** 复选框，将 **“错误”** 和 **“警告”** 复选框保留为选中状态。

1. 单击 **“Windows 性能计数器”**，单击 **“+ 添加性能计数器”**，查看可用的性能计数器列表，然后添加以下计数器：

    - 处理(\*)\%处理器时间
    - 适用于 Windows 的事件跟踪\总内存使用量 --- 非分页池
    - 适用于 Windows 的事件跟踪\总内存使用量 --- 分页池

    >**备注**： 添加计数器并配置为 60 秒的收集采样间隔。
  
1. 在 **“代理配置”** 边栏选项卡上，单击 **“应用”**。

#### 任务 5：查看和查询收集的数据

此任务将对数据收集运行日志搜索。 

1. 在 Azure 门户中，导航回到在本练习前面创建的 Log Analytics 工作区。

1. 在“Log Analytics 工作区”边栏选项卡上，单击 **“常规”** 部分中的 **“日志”**。

1. 根据需要关闭 **“欢迎使用日志分析”窗口**。 

1. 在 **“查询”** 窗格上的 **“所有查询”** 列中，向下滚动到资源类型列表的底部，然后单击 **“虚拟机”**
    
1. 查看预定义查询列表，选择 **“内存和 CPU 使用情况”**，然后单击相应的 **“运行”** 按钮。

    >**备注**： 你可以从查询**虚拟机可用内存**开始。如果没有任何结果，请检查范围是否设置为虚拟机

1. 该查询将在新的查询选项卡中自动打开。 

    >**备注**： Log Analytics 使用 Kusto 查询语言。你可以自定义现有查询或创建自己的查询。 

    >**备注**： 所选查询的结果将自动显示在查询窗格下方。要重新运行查询，请单击 **“运行”**。

    >**备注**： 由于此虚拟机是刚刚创建的，因此可能还没有任何数据。 

    >**备注**： 你可以选择以不同的格式显示数据。你还可以选择根据查询结果创建警报规则。

    >**备注**：可使用以下步骤在本实验室前面部分部署的 Azure VM 上生成一些额外的负载：

    1. 导航到 Azure VM 边栏选项卡。
    2. 在 Azure VM 边栏选项卡的“**操作**”部分，选择“**运行命令**”，在“**RunPowerShellScript**”边栏选项卡上，键入以下脚本，然后单击“**运行**”：
    3. 
       ```cmd
       cmd
       :loop
       dir c:\ /s > SWAP
       goto loop
       ```
       
    1. 切换回“Log Analytics”边栏选项卡，并重新运行查询。可能需要等待几分钟来完成数据收集过程，然后再次重新运行查询。

> 结果：你使用 Log Analytics 工作区配置了数据源和查询日志。 

**清理资源**

>**备注**： 请勿从此实验室中删除资源，因为 Azure 安全中心实验室和 Azure Sentinel 实验室需要这些资源。
 
