---
lab:
    title: '11 - 保护 Azure SQL 数据库'
    module: '模块 03 - 保护数据和应用程序'
---

# 实验室 11：保护 Azure SQL 数据库
# 学生实验室手册

## 实验室场景

你需要查看 Azure SQL 数据库的安全功能。具体来说，你感兴趣的是：

- 防范诸如 SQL 注入和数据外泄之类的攻击。 
- 能够发现数据库信息并将其分类为机密等类别。 
- 能够审核数据库服务器和数据库查询以及日志事件。 

> 对于本实验室中的所有资源，我们使用“**美国东部**”区域。请与讲师确认这是课堂上所使用的区域。 

## 实验室目标

在本实验室中，你将完成以下练习：

- 练习 1：实现 SQL 数据库安全功能

## 实验室文件：

- **\\Allfiles\\Labs\\11\\azuredeploy.json**

### 练习 1：实现 SQL 数据库安全功能

### 预计用时：30 分钟

在该练习中，你将完成以下任务：

- 任务 1：部署 Azure SQL 数据库
- 任务 2：配置高级数据保护
- 任务 3：配置数据分类
- 任务 4：配置审核

#### 任务 1：部署 Azure SQL 数据库

在此任务中，你将使用模板来部署实验室基础结构。 

1. 登录 Azure 门户 **`https://portal.azure.com/`**。

    >**备注**：使用此实验室使用的 Azure 订阅中具有所有者或参与者角色的帐户登录 Azure 门户。

1. 在 Azure 门户页面顶部的“**搜索资源、服务和文档**”文本框中，键入“**部署自定义模板**”，然后按 **Enter** 键。

1. 在“**自定义部署**”边栏选项卡中，单击“**在编辑器中构建自己的模板**”选项。

1. 在“**编辑模板**”边栏选项卡中，单击“**加载文件**”，找到 **\\Allfiles\\Labs\\11\\azuredeploy.json** 文件并单击“**打开**”。

    >**备注**：查看模板内容，并注意该模板可部署 Azure SQL 数据库。

1. 在“**编辑模板**”边栏选项卡上，单击“**保存**”。

1. 在“**自定义部署**”边栏选项卡上，确保已配置以下设置（其他设置保留为默认值）：

   |设置|值|
   |---|---|
   |订阅|本实验室将使用的 Azure 订阅的名称|
   |资源组|单击“**新建**”并键入名称 **AZ500LAB11**|
   |位置|**（美国）美国东部**|

1. 单击“**查看 + 创建**”，然后单击“**创建**”。

    >**备注**：等待部署完成。 

#### 任务 2：配置高级数据保护

1. 在 Azure 门户页面顶部的“**搜索资源、服务和文档**”文本框中，键入“**资源组**”，然后按 **Enter** 键。

1. 在“**资源组**”边栏选项卡上，在资源组列表中，单击“**AZ500LAB11**”条目。

1. 在“**AZ500LAB11**”边栏选项卡中，单击表示新创建的 SQL Server 的条目。

1. 在“SQL Server”边栏选项卡上的“**安全**”部分，单击“**Microsoft Defender for Cloud**”。

1. 单击“**Microsoft Defender for SQL**”中的“启用 **Microsoft Defender for SQL**”。

      >**备注**：等到“启用 Azure Defender for SQL”选项出现。

1. 在“**Microsoft Defender for SQL: 在服务器级别启用(配置)**”参数中，单击“**(配置)**”。   
    
1. 在“**服务器设置**”边栏选项卡上，查看有关定价和试用期、 **漏洞评估设置** **和高级威胁防护设置的信息**。

1. 回到“**Microsoft Defender for Cloud**”边栏选项卡，查看“**建议**”和“**安全警报**”。

      >**备注**：建议可能需要 10-15 分钟才会出现在“**Microsoft Defender for Cloud**”边栏选项卡上。不要等待，继续下一个任务，完成所有剩余任务后再回到此边栏选项卡。


#### 任务 3：配置数据分类

在本任务中，你将发现 SQL 数据库中的信息并对其进行分类，以实现 GPDR 和数据保护合规性。

1. 在“SQL Server”边栏选项卡上的“**设置**”部分，单击“**SQL 数据库**”。

1. 在数据库列表中，选择 **AZ500LabDb** 条目。 

1. 在 **AZ500LabDb** SQL 数据库边栏选项卡的“**安全**”部分，单击“**数据发现和分类**”。

1. 在“**数据发现与分类**”边栏选项卡中，单击“**分类**”选项卡。

    >**备注**：分类引擎会扫描数据库以查找包含潜在敏感数据的列，并提供建议的列分类列表。

1. 单击边栏选项卡顶部蓝色栏中显示的文本消息“**我们找到了 15 个带有分类建议的列**”。

1. 查看列出的列和推荐的敏感度标签。 

1. 启用“**全选**”复选框，然后单击“**接受所选的建议**”。

    >**备注**：或者，可以只选择某些列，而忽略其他列。 

    >**备注**：你可以选择更改信息类型和敏感度标签。 

1. 完成审核后，单击“**保存**”。 

    >**备注**：这将完成分类，并使用新的分类元数据持久地标记数据库列。 

1. 返回“**数据发现和分类**”边栏选项卡，请注意，它已更新，用于说明最新的分类信息。 

#### 任务 4：配置审核 

在此任务中，你将首先配置服务器级审核，然后配置数据库级审核。 

1. 在 Azure 门户中，导航回“SQL Server”边栏选项卡。

1. 在“SQL Server”边栏选项卡上的“**安全**”部分，单击“**审核**”。

    >**备注**：这是服务器级别审核。默认审核设置包括针对数据库执行的所有查询和存储过程，以及成功和失败的登录。

1. 将“**启用 Azure SQL 审核**”切换设置为“**打开**”以启用审核。 

1. 选择“**存储**”复选框，将显示“**订阅**”和“**存储帐户**”的输入框。

1. 从下拉列表中选择“**订阅**”。

1. 单击“**存储帐户**”并选择“**新建**”。

1. 在“**创建存储帐户**”边栏选项卡上的“**名称**”框中，键入一个由 3 至 24 个小写字母和数字组成的全局唯一名称，然后单击“**确定**”， 

1. 回到“**审核**”边栏选项卡，将“**高级属性**”下的“**保留期(天数)**”设置为 **5**。 

1. 在“审核”边栏选项卡上，单击“**保存**”以保存审核设置。 

    >**备注**：如果收到有关无效存储容器路径的错误消息，则可能尚未预配存储帐户。等待几分钟，单击“**存储帐户**”，在“**选择存储帐户**”边栏选项卡中，选择新创建的存储帐户，然后返回到“审核”边栏选项卡，单击“**保存**”。

1. 在“服务器”边栏选项卡上的“**设置**”部分，单击“**SQL 数据库**”。

1. 在数据库列表中，选择 **AZ500LabDb** 条目。 

1. 在 **AZ500LabDb** SQL 数据库边栏选项卡上的“**安全**”部分，单击“**审核**”。 

    >**备注**：这是数据库级别审核。服务器级审核已启用。 
  
    >**备注**：审核可以写入 Azure 存储帐户、Log Analytics 工作区或事件中心。你可以配置这些选项的任意组合。

    >**备注**：如果在服务器上启用基于存储的审核，则无论数据库设置如何，该审核将始终应用于数据库。

1. 单击“**查看审核日志**”。

1. 在“**审核记录**”边栏选项卡中，请注意，你可以在服务器审核和数据库审核之间切换。 

    >**备注**：由于此 SQL Server 和数据库是最近创建的，因此目前不太可能有任何事件可用。 

> 结果：你已创建 SQL Server 和数据库，已配置数据分类和审核。 


**清理资源**

> 请记得删除任何新创建而不会再使用的 Azure 资源。删除未使用的资源，确保不产生意外成本。 

1. 在 Azure 门户中，通过单击 Azure 门户右上角的第一个图标打开 Cloud Shell。如果出现提示，请单击“**PowerShell**”和“**创建存储**”。

1. 确保在“Cloud Shell”窗格左上角的下拉菜单中选中“**PowerShell**”。

1. 在“Cloud Shell”窗格中的 PowerShell 会话中，运行以下命令删除在此实验室中创建的资源组：
  
    ```powershell
    Remove-AzResourceGroup -Name "AZ500LAB11" -Force -AsJob
    ```
1. 关闭 **Cloud Shell** 窗格。 
